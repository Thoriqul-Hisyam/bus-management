// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model BusType {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  buses     Bus[]
  
  @@map("bus_type")
}

model Bus {
  id        Int       @id @default(autoincrement())
  name      String
  plateNo   String    @unique
  capacity  Int
  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now())

  busTypeId Int
  busType   BusType   @relation(fields: [busTypeId], references: [id])

  bookings  Booking[]
}

model Position {
  id         Int        @id @default(autoincrement())
  name       String     @unique @db.VarChar(255)
  employees  Employee[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @default(now())

  @@map("position")
}

model Employee {
  id         Int        @id @default(autoincrement())
  fullName   String     @db.VarChar(255)
  phone      String?     @db.VarChar(255)
  positionId Int
  position   Position   @relation(fields: [positionId], references: [id])
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @default(now())

  // relations tambahan
  account    Account?

  bookingsAsDriver   Booking[] @relation("DriverBookings")
  bookingsAsCoDriver Booking[] @relation("CoDriverBookings")
  bookingsAsSales    Booking[] @relation("SalesBookings")

  @@map("employee")
}

//////////////////////////////////////////////////////
// TAMBAHAN ENUM UNTUK BOOKING & PAYMENT
//////////////////////////////////////////////////////

enum BookingStatus {
  DRAFT
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentType {
  DP
  FULL
  OTHER
}

//////////////////////////////////////////////////////
// TAMBAHAN MODEL (selaras DBML kamu)
//////////////////////////////////////////////////////

model Account {
  id           Int       @id @default(autoincrement())
  employeeId   Int       @unique
  username     String    @unique
  passwordHash String
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now())

  employee     Employee  @relation(fields: [employeeId], references: [id])

  @@map("account")
}

model Customer {
  id        Int       @id @default(autoincrement())
  name      String
  phone     String?
  travel    String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now())

  bookings  Booking[]
  @@map("customer")
}

model Booking {
  id            Int           @id @default(autoincrement())
  code          String        @unique
  customerId    Int
  busId         Int

  pickupAt      DateTime?
  pickupAddress String?       @db.Text
  destination   String?

  seatsBooked   Int?
  priceTotal    Decimal?      @db.Decimal(12, 2)

  legrest       Boolean       @default(false)

  driverId      Int?
  driver        Employee?     @relation("DriverBookings", fields: [driverId], references: [id])

  coDriverId    Int?
  coDriver      Employee?     @relation("CoDriverBookings", fields: [coDriverId], references: [id])

  salesId       Int?
  sales         Employee?     @relation("SalesBookings", fields: [salesId], references: [id])

  rentStartAt   DateTime?
  rentEndAt     DateTime?
  status        BookingStatus @default(DRAFT)
  notes         String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @default(now())
  deletedAt     DateTime?

  // relations
  customer      Customer      @relation(fields: [customerId], references: [id])
  bus           Bus           @relation(fields: [busId], references: [id])
  payments      Payment[]
  tripSheets  TripSheet[]

  @@index([busId, rentStartAt, rentEndAt])
  @@index([status])
  @@index([pickupAt])
  @@map("booking")
  
}

model Payment {
  id         Int         @id @default(autoincrement())
  bookingId  Int
  type       PaymentType
  amount     Decimal     @db.Decimal(12, 2)
  paidAt     DateTime
  notes      String?     @db.Text
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @default(now())

  booking    Booking     @relation(fields: [bookingId], references: [id])

  @@index([bookingId, type])
  @@index([paidAt])
  @@map("payment")
}

model TripSheet {
  id              Int       @id @default(autoincrement())

  bookingId       Int       @unique

  description     String?   // keterangan
  sangu           Decimal?  @db.Decimal(12, 2)
  premiDriver     Decimal?  @db.Decimal(12, 2)
  premiCoDriver   Decimal?  @db.Decimal(12, 2)
  umDriver        Decimal?  @db.Decimal(12, 2)
  umCoDriver      Decimal?  @db.Decimal(12, 2)
  bbm             Decimal?  @db.Decimal(12, 2)
  total           Decimal?  @db.Decimal(12, 2)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  booking         Booking   @relation(fields: [bookingId], references: [id])
  
  @@map("tripsheet")
}
